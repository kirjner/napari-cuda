# Greenfield Protocol Field Inventory

Authoritative checklist distilled from `docs/protocol_greenfield.md` §§2–14 (including Appendix A). Use this as the quick-reference source of truth for envelope requirements, payload shape, sequencing semantics, optional behaviours, and timing guarantees across every frame family.

| Frame | Envelope requirements | Payload schema | Resumability / sequencing | Optional behaviours & notes |
|-------|-----------------------|----------------|---------------------------|-----------------------------|
| `session.hello` | `type`=`"session.hello"`; `version`=1; `frame_id` (UUID, required pre-session); `timestamp` (float seconds); *no* `session`, `seq`, `delta_token`, `intent_id` | `protocols`: list[int]; `client`: {`name`: str, `version`: str, `platform`: str}; `features`: {topic: bool}; `resume_tokens`: {topic: str or null}; optional `auth`: {`type`: str, token/mtls fields}; optional future capability flags | Not resumable; sequencing unused. `frame_id` used purely for observability. | Client may omit unsupported features; resume tokens ignored when topic disabled; auth optional by deployment. |
| `session.welcome` | `type`=`"session.welcome"`; `version`=1; `session` (UUID, required); `frame_id`; `timestamp`; no `seq`, `delta_token`, `intent_id` | `protocol_version`: int; `session`: {`id`: UUID, `heartbeat_s`: float, optional `ack_timeout_ms`: int}; `features`: per topic {`enabled`: bool, optional `version`: int, `resume`: bool, optional `commands`: list[str]} | Not resumable; establishes baseline. Server emits notify snapshot(s) immediately after. | Advertised features govern downstream lanes; clients must honour downgrades and `ack_timeout_ms`. |
| `session.reject` | `type`, `version`, `frame_id`, `timestamp`; no `session`, `seq`, `delta_token`, `intent_id` | `code`: str; `message`: str; optional `details`: mapping | Not resumable. | Final frame on handshake failure; socket closes immediately. |
| `session.heartbeat` | `type`, `version`, `session`, `frame_id`, `timestamp`; no `seq`, `delta_token`, `intent_id` | Empty object `{}` | Not resumable; cadence = `heartbeat_s`. | Server sends periodically; triggers client `session.ack` unless other traffic already proves liveness. |
| `session.ack` | `type`, `version`, `session`, `frame_id`, `timestamp`; no `seq`, `delta_token`, `intent_id` | Empty object `{}` | Not resumable. | Sent by client when no other frames were emitted during heartbeat window. |
| `session.goodbye` | `type`, `version`, `session`, `frame_id`, `timestamp`; `seq`/`delta_token` absent; `intent_id` unused | Optional `code`: str; `message`: str; `reason`: str | Not resumable. | Used for graceful shutdown or after fatal faults; server sends before closing sockets. |
| `notify.scene` | `type`, `version`, `session`, optional short `frame_id`; **requires** `seq`, `delta_token`, `timestamp`; `intent_id` optional when echoing client intent | Full snapshot: `viewer` (dims, camera, settings), `layers[]` (id/type/name/metadata/render/multiscale/source), `policies`, optional scene `metadata` (source_path, volume_state, policy_metrics) | Resumable baseline. Snapshots use `seq = 0`; issuing snapshot resets `seq`/token for all resumable topics. | Must be first notify after welcome; clients discard cached tokens when new snapshot appears. |
| `notify.layers` | `type`, `version`, `session`, optional `frame_id`; **requires** `seq`, `delta_token`, `timestamp`; `intent_id` optional for local intent echoes | `layer_id`: str; `changes`: mapping of mutated fields (diff format per layer type) | Resumable ring buffer (≥512 deltas or 5 min). `seq` increments per delta; reset follows new snapshot epoch. | If resume token stale, server replays snapshot then current deltas; clients track tokens per topic. |
| `notify.stream` | `type`, `version`, `session`, optional `frame_id`; **requires** `seq`, `delta_token`, `timestamp`; `intent_id` unused | `codec`: str; `format`: str; `fps`: float; `frame_size`: [int, int]; `nal_length_size`: int; `avcc`: base64 str; `latency_policy`: mapping; `vt_hint`: mapping | Resumable (latest config). `seq` increments on changes; resets with new snapshot epoch. | Payload is authoritative stream config; optional fields defined in schema. |
| `notify.dims` | `type`, `version`, `session`, `timestamp`; **omit** `seq`, `delta_token`; include either `intent_id` (preferred) or short `frame_id` | `current_step`: list[int]; `ndisplay`: int; `mode`: str; `source`: str; optional `intent_id`: str | Non-resumable hot path. | When server cannot link to intent, it emits short `frame_id`; reconnect relies on notify.scene baseline. |
| `notify.camera` | `type`, `version`, `session`, `timestamp`; omit `seq`/`delta_token`; include `intent_id` or short `frame_id` | `mode`: str; `delta`: mapping (orbit/pan/zoom deltas); `origin`: str; optional `intent_id`: str | Non-resumable hot path. | Target payload ≤200 B; clients reconcile using `intent_id` when present. |
| `notify.telemetry` | `type`, `version`, `session`, `timestamp`; omit `seq`/`delta_token`; `frame_id` optional | Rolling metrics: `presenter`, `decode`, `queue_depth` floats | Non-resumable diagnostic lane. | Clients may drop when disabled; high-frequency stream. |
| `notify.error` | `type`, `version`, `session`, `timestamp`; optional `frame_id`; omit `seq`/`delta_token`; `intent_id` unused | `domain`: str; `code`: str; `message`: str; `severity`: {`info`, `warning`, `critical`}; optional `context`: mapping | Non-resumable. | Severity `critical` requires `session.goodbye` and coordinated shutdown; lower severities allow continued operation. |
| `state.update` | `type`, `version`, `session`, `frame_id` (UUID), `timestamp`; `intent_id` required; omit `seq`, `delta_token` | `scope`: str; `target`: str; `key`: str; `value`: JSON value adhering to scope schema | Acked lane; no sequencing. | Client retries only when documented idempotent; payload excludes legacy `extras`/`controls`. |
| `ack.state` | `type`, `version`, `session`, `frame_id`, `timestamp`; `seq`/`delta_token` absent; `intent_id` carried inside payload | `intent_id`: str; `in_reply_to`: str (state frame_id); `status`: {`accepted`,`rejected`}; optional `applied_value`; on rejection `error`: {`code`, `message`, optional `details`} | Ack lane; no sequencing. | Must arrive within `ack_timeout_ms` (default 250 ms) from welcome; missing ack treated as failure. |
| `call.command` | `type`, `version`, `session`, `frame_id`, `timestamp`; no `seq`, `delta_token`, `intent_id` | `command`: str; `args`: list; `kwargs`: dict; optional `origin`: str | Command lane; no sequencing. | Non-idempotent unless reply/error includes `idempotency_key`; server validates command against feature catalogue. |
| `reply.command` | `type`, `version`, `session`, `frame_id`, `timestamp`; no `seq`, `delta_token`, `intent_id` | `in_reply_to`: str; `status`="ok"; optional `result`; optional `idempotency_key` | Ack lane; no sequencing. | Emits even when `result` is null; resulting state still flows through notify lanes. |
| `error.command` | `type`, `version`, `session`, `frame_id`, `timestamp`; no `seq`, `delta_token`, `intent_id` | `in_reply_to`: str; `status`="error"; `code`: str; `message`: str; optional `details`: mapping; optional `idempotency_key` (for retryable cases) | Ack lane; no sequencing. | Codes include `command.forbidden`, `command.not_found`, `command.retryable`; server flushes outstanding replies before fatal shutdown. |

### Sequencing & Resume Summary

- Resumable topics (`notify.scene`, `notify.layers`, `notify.stream`) always carry `seq` plus `delta_token`; snapshots reset `seq` to 0 and issue fresh tokens across all resumable lanes.
- Non-resumable topics omit `seq`/`delta_token`. `notify.dims` and `notify.camera` must include either the originating `intent_id` or a short `frame_id` for telemetry reconciliation.
- Acked lanes (`state.update`, `ack.state`, `call.command`, `reply.command`, `error.command`) require `frame_id` to correlate responses; they never include `seq`.
- Clients persist the latest `seq`/`delta_token` per resumable topic and provide them via `session.hello.resume_tokens`; stale tokens trigger a snapshot replay without an error.
- `notify.error` with `severity = "critical"` must be followed by `session.goodbye` after flushing any pending `ack.state`, `reply.command`, or `error.command` frames; the pixel channel closes with code 1011.

### Timing & Optional Behaviour Highlights

- Heartbeat cadence uses `session.welcome.payload.session.heartbeat_s`; the client sends `session.ack` within that window unless other traffic has already demonstrated liveness.
- `ack.state` deadline equals `ack_timeout_ms` (default 250 ms) from the welcome payload; clients treat timeout as failure and may retry only when the action is explicitly idempotent.
- Command idempotency: retry only when `reply.command` or `error.command` includes `idempotency_key` alongside `error.code = "command.retryable"`.
- Graceful shutdown: either side may send `session.goodbye`; after fatal `notify.error` (severity `critical`) the server sends goodbye and closes both state and pixel sockets (pixel uses close code 1011).
- Hot-path notifications (`notify.dims`, `notify.camera`) target ≤200 B payloads at up to 60 Hz; keep JSON flat and rely on transport compression where available.
